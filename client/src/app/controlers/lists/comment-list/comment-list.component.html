<!-- Список комментариев -->
<ng-container *ngIf="!loading; else loader">
  <div class="list"
       *ngIf="!!comments?.length; else noComments">
    <!-- Загрузчик следующих комментариев -->
    <ng-container [ngTemplateOutlet]="moreCommentsDetector"
                  [ngTemplateOutletContext]="{ loading: nextLoading, leftItems: nextLeftCount, next: true }"></ng-container>
    <!-- Элемент комментария -->
    <div #comment
         class="comment"
         [attr.comment-id]="comment.id"
         *ngFor="let comment of comments; trackBy: listTrackBy">
      <!-- Аватарка -->
      <a class="comment__avatar"
         routerLink="/profile/{{comment.user.id}}"
         background="fill"
         color="primary">
        <!-- Картинка -->
        <img [src]="comment.user.avatars.small"
             *ngIf="comment.user.avatars.small.length > 0" />
        <!-- Иконка -->
        <mat-icon *ngIf="comment.user.avatars.small.length === 0">person</mat-icon>
        <!-- Метка онлайн -->
        <div class="comment__header-avatar-online"
             *ngIf="comment.user.online"></div>
      </a>
      <!-- Коммантарий -->
      <div class="comment__data">
        <!-- Описание -->
        <div class="comment__header">
          <!-- Имя -->
          <div class="comment__header-text">
            <a class="comment__header-name"
               routerLink="/profile/{{comment.user.id}}">{{comment.user.name}} {{comment.user.lastName}}</a>
            <!-- Дата -->
            <div class="comment__header-state">
              <time [attr.datetime]="comment.createDate.toISOString()">{{comment.createDate | date: 'd.M.y - H:mm'}}</time>
              <!-- Ответ пользователю -->
              <ng-container *ngIf="!!comment.replyToUser && comment.user.id !== comment.replyToUser.id">
                - Ответ
                <a routerLink="/profile/{{comment.replyToUser.id}}">
                  {{comment.replyToUser | petrovich: [3, 'first'] }} {{comment.replyToUser | petrovich: [3, 'last'] }}
                </a>
              </ng-container>
            </div>
          </div>
          <!-- Действия -->
          <div class="comment____header-actions">
            <!-- Ответить -->
            <button mat-icon-button
                    color="primary"
                    matTooltip="Ответить"
                    (click)="onReply(comment.user)"
                    *ngIf="isReplyAvail(comment)">
              <mat-icon>reply</mat-icon>
            </button>
            <!-- Удалить -->
            <button mat-icon-button
                    color="warn"
                    matTooltip="Удалить"
                    *ngIf="isDeleteAvail(comment)">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        </div>
        <!-- Содержимое -->
        <div class="comment__body"
             [attr.attachments-count]="attachmentCount"
             *ngVar="getAttachmentCount(comment) as attachmentCount">
          <!-- Прикрепления -->
          <ng-container *ngIf="attachmentCount > 0">
            <!-- Граффити -->
            <ng-container *ngVar="comment?.attachment?.graffity as graffity">
              <ng-container [ngTemplateOutlet]="imageAttachment"
                            [ngTemplateOutletContext]="{ $implicit: { src: graffity?.url } }"></ng-container>
            </ng-container>
            <!-- Сновидение -->
            <ng-container *ngVar="comment?.attachment?.dreams as dreams">
              <ng-container [ngTemplateOutlet]="dreamAttachment"
                            [ngTemplateOutletContext]="{ dreams }"></ng-container>
            </ng-container>
          </ng-container>
          <!-- Текст комментария -->
          <p class="comment__body-text"
             [innerHTML]="comment.text | comment"
             *ngIf="!!comment?.text"></p>
        </div>
      </div>
    </div>
    <!-- Загрузчик предыдущих комментариев -->
    <ng-container [ngTemplateOutlet]="moreCommentsDetector"
                  [ngTemplateOutletContext]="{ loading: prevLoading, leftItems: prevLeftCount, next: false }"></ng-container>
  </div>
</ng-container>



<!-- Детектор загрузки новых комментариев -->
<ng-template #moreCommentsDetector
             let-loading="loading"
             let-leftItems="leftItems"
             let-next="next">
  <!-- Детектирующий элемент -->
  <div scrollDetector
       class="comment__more-loader"
       [ngClass]="{ loading, next, prev: !next }"
       [detectDirection]="next? -1: 1"
       (inScreenEvent)="onLoadMoreComments(next)"
       *ngIf="leftItems > 0">
    <!-- Загрузчик -->
    <ng-container [ngTemplateOutlet]="loader"
                  *ngIf="loading"></ng-container>
  </div>
</ng-template>

<!-- Загрузчик -->
<ng-template #loader>
  <app-inform mainTitle="Загрузка комментариев"
              subTitle="Пожалуйста подождите"
              [waitPointers]="true"
              [smallMargins]="true"></app-inform>
</ng-template>

<!-- Комментариев нет -->
<ng-template #noComments>
  <app-inform icon="quickreply"
              [mainTitle]="emptyCommentsMainTitle"
              [subTitle]="emptyCommentsSubTitle"
              [smallMargins]="true"
              [aboveIcon]="true"></app-inform>
</ng-template>



<!-- Граффити в закреплении -->
<ng-template #imageAttachment
             let-image>
  <div class="comment__body-attachment"
       *ngIf="!!image?.src">
    <div class="comment__body-attachment-data">
      <img class="image"
           [src]="image.src" />
    </div>
  </div>
</ng-template>

<!-- Сновидение в закреплении -->
<ng-template #dreamAttachment
             let-dreams="dreams">
  <ng-container *ngIf="!!dreams?.length">
    <div class="comment__body-attachment"
         *ngFor="let dream of dreams">
      <div class="comment__body-attachment-data">
        <div class="dream"></div>
      </div>
    </div>
  </ng-container>
</ng-template>